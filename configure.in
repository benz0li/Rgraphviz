AC_INIT(src/Rgraphviz.c)
AC_PREREQ(2.13)

AC_ARG_WITH(graphviz,
            [ --with-graphviz=DIR      root directory of graphviz installation 
                          (defaults to /usr/local/)],
GRAPHVIZ_DIR="${with_graphviz}",
GRAPHVIZ_DIR="")

dnl Use pkg-config if user doesn't specify --with-graphviz arg
if test -z "${GRAPHVIZ_DIR}"; then
   if test -z "${PKG_CONFIG}" ; then
      AC_PATH_PROG(PKG_CONFIG, pkg-config)
   fi
   if test -z "${PKG_CONFIG}" ; then
      AC_MSG_RESULT(failed)
      AC_MSG_ERROR(pkg-config was not found, please specify the prefix for your graphviz installation using --with-graphviz=DIR.)
      exit 1
   fi
   GVIZ_DEFS="-DGRAPHVIZGT_2_4 -DGRAPHVIZGT_1_16"
   GRAPHVIZ_CONFIG="$PKG_CONFIG libgvc"
   PKG_CPPFLAGS="`${GRAPHVIZ_CONFIG} --cflags || echo ''`"
   if test -z "${PKG_CPPFLAGS}"; then
      AC_MSG_RESULT(failed)
      AC_MSG_ERROR(pkg-config was not able to find graphviz.  Verify graphviz is installed and that PKG_CONFIG_PATH is correct.)
      exit 1
   fi
   PKG_LIBS="`${GRAPHVIZ_CONFIG} --libs`"
   VERSTR="`${GRAPHVIZ_CONFIG} --modversion`"
   AC_MSG_NOTICE(Found graphviz $VERSTR)
else 
    dnl User specified --with-graphviz DIR
    DOT="${GRAPHVIZ_DIR}/bin/dot"
    if ! test -x "${DOT}"; then
       AC_MSG_ERROR($DOT not found.)
       exit 1
    fi
    VERSTR=`${DOT} -V 2>&1 | cut -f3 -d" "`
    MAJOR=`echo ${VERSTR} | cut -f1 -d"."`
    MINOR=`echo ${VERSTR} | cut -f2 -d"."`
    AC_MSG_NOTICE(Found graphviz $VERSTR)
    if test ${MAJOR} -lt "2" || test ${MINOR} -lt "4"; then
       AC_MSG_ERROR("Need graphviz >= 2.4")
       exit 1
    fi
    GVIZ_DEFS="-DGRAPHVIZGT_2_4 -DGRAPHVIZGT_1_16"
    PKG_CPPFLAGS="-I${GRAPHVIZ_DIR}/include/graphviz"
    PKG_LIBS="-L${GRAPHVIZ_DIR}/lib/graphviz -lgvc"
fi

AC_SUBST(GVIZ_DEFS)
AC_SUBST(PKG_CPPFLAGS)
AC_SUBST(PKG_LIBS)
AC_OUTPUT(src/Makevars)
